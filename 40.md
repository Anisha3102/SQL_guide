# How do you handle errors in SQL procedures or transactions?

## Error Handling in SQL Procedures & Transactions

- SQL provides mechanisms to detect, handle, and recover from errors so data integrity is preserved.
- Approaches differ slightly across DBMS (SQL Server, MySQL, PostgreSQL, Oracle).

## 1. Using Transactions with ROLLBACK / COMMIT

- Wrap multiple statements in a transaction.

- If an error occurs → ROLLBACK to undo changes.

- If successful → COMMIT changes.

### Example (generic SQL):
```sql
BEGIN TRANSACTION;

UPDATE accounts
SET balance = balance - 500
WHERE account_id = 1;

UPDATE accounts
SET balance = balance + 500
WHERE account_id = 2;

-- If no errors:
COMMIT;

-- If error occurs:
ROLLBACK;

```
- Ensures atomicity → either both updates succeed, or none.

## 2. Error Handling in SQL Server (TRY...CATCH)

- SQL Server supports TRY...CATCH for stored procedures:
```sql
BEGIN TRY
    BEGIN TRANSACTION;

    UPDATE accounts SET balance = balance - 500 WHERE account_id = 1;
    UPDATE accounts SET balance = balance + 500 WHERE account_id = 2;

    COMMIT TRANSACTION;
END TRY
BEGIN CATCH
    ROLLBACK TRANSACTION;

    PRINT 'Error occurred: ' + ERROR_MESSAGE();
END CATCH;
```

- If any error happens inside TRY, control goes to CATCH.

## 3. Error Handling in MySQL (DECLARE HANDLER)

- MySQL uses handlers inside stored procedures:
```sql
DELIMITER $$

CREATE PROCEDURE transfer_money()
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 'Error occurred, transaction rolled back';
    END;

    START TRANSACTION;

    UPDATE accounts SET balance = balance - 500 WHERE account_id = 1;
    UPDATE accounts SET balance = balance + 500 WHERE account_id = 2;

    COMMIT;
END $$

DELIMITER ;

```
- DECLARE EXIT HANDLER ensures rollback on any SQL error.

## 4. Error Handling in PostgreSQL (EXCEPTION in PL/pgSQL)

- Postgres uses BEGIN … EXCEPTION … END:
```sql
DO $$
BEGIN
    BEGIN
        UPDATE accounts SET balance = balance - 500 WHERE account_id = 1;
        UPDATE accounts SET balance = balance + 500 WHERE account_id = 2;
    EXCEPTION WHEN OTHERS THEN
        RAISE NOTICE 'Error occurred, rolling back';
        ROLLBACK;
    END;
END $$;
```
## 5. Error Handling in Oracle PL/SQL

- Oracle uses EXCEPTION blocks:
```sql
BEGIN
    UPDATE accounts SET balance = balance - 500 WHERE account_id = 1;
    UPDATE accounts SET balance = balance + 500 WHERE account_id = 2;
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE('Error occurred, transaction rolled back');
END;
```